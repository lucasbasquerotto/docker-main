{% set var_local = params.main.local | default(false) | bool %}
{% set var_remote = params.main.local | default(false) | bool | ternary('false', 'true') %}
{% set var_run = params.main.run | default({}) %}

{% set var_containers_dict = params.main.containers_dict | default({}) %}
{% set var_compose_orchestration = params.pod.pod.orchestration in ['compose', 'none'] %}

env_files:
- src: "test/test.txt"
  dest: "test/test.local.efk3.txt"
  when: "{{ var_local }}"
- src: "test/test.txt"
  dest: "test/test.local.efk4.txt"
  when: "{{ var_local }}"
- src: "test/test.txt"
  dest: "test/test.remote.efk3.txt"
  when: "{{ var_remote }}"
- src: "test/test.txt"
  dest: "test/test.remote.efk4.txt"
  when: "{{ var_remote }}"

env_templates:
- src: "test/template.yml"
  dest: "test/template.local.efk3.yml"
  params: {{ params | to_json }}
  when: "{{ var_local }}"
- src: "test/template.yml"
  dest: "test/template.local.efk4.yml"
  params: {{ params | to_json }}
  when: "{{ var_local }}"
- src: "test/template.yml"
  dest: "test/template.remote.efk3.yml"
  params: {{ params | to_json }}
  when: "{{ var_remote }}"
- src: "test/template.yml"
  dest: "test/template.remote.efk4.yml"
  params: {{ params | to_json }}
  when: "{{ var_remote }}"

children:

- name: "main/vars/vars.main.yml"
  params:
    env_params: {{ params | to_json }}
    volumes_dict: 
      elasticsearch:
        rel_path: "elasticsearch"
        mode: "0777"
    services_data_dict: 
      fluentd:
        elasticsearch_port: "{{ var_containers_dict.elasticsearch.port | default('9200') }}"
        flush_interval: "{{ var_containers_dict.fluentd.flush_interval | default('1s') }}"

{% if var_compose_orchestration %}

- name: "main/compose/vars.compose.yml"
  params: 
    env_params: {{ params | to_json }}
    env_params_list: []

{% else %}
  {% set error = {} %}
  {{ error['error.orchestration.invalid.' + params.pod.pod.orchestration] }}
{% endif %}