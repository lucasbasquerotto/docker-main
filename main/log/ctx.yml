{% set var_env = params.env_name %}
{% set var_ctx = params.ctx_name %}
{% set var_local = params.main.local | default(false) | bool %}
{% set var_remote = params.main.local | default(false) | bool | ternary('false', 'true') %}
{% set var_run = params.main.run | default({}) %}
{% set var_run_dict = params.main.run_dict | default({}) %}

{% set var_containers_dict = params.main.containers_dict | default({}) %}
{% set var_compose_orchestration = params.main.orchestration in ['docker_compose', 'none'] %}

{% set var_pod_dir_rel = '../../../..' %}
{% set var_data_dir = var_local 
  | ternary(var_pod_dir_rel + '/' + params.pod.data_dir, params.pod.data_dir) %}

{% set var_pod_type = params.main.type | default('') %}

{% if not (var_pod_type in ['app']) %}
  {% set error = {} %}
  {{ error['error.pod_type.invalid.' + var_pod_type] }}
{% endif %}

children:

{% if var_compose_orchestration %}

- name: "main/compose/vars.compose.yml"
  params: 
    env_params: {{ params | to_json }}
    env_params_list: 
      - "DATA_DIR={{ var_data_dir }}"

{% else %}
  {% set error = {} %}
  {{ error['error.orchestration.invalid.' + params.main.orchestration] }}
{% endif %}

- name: "main/vars/vars.main.yml"
  params:
    env_params: {{ params | to_json }}
    dynamic: true
    volumes_dict: 
      elasticsearch:
        rel_path: "elasticsearch"
        mode: "0777"
    services_data_dict: 
      fluentd:
        elasticsearch_port: "{{ var_containers_dict.elasticsearch.port | default('9200') }}"
        flush_interval: "{{ var_containers_dict.fluentd.flush_interval | default('1s') }}"
    run: {{ var_run | to_json }}
    run_dict: {{ var_run_dict | to_json }}
    run_custom:
      var_pod_type: "{{ var_pod_type }}"
