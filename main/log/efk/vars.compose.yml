

{% if params.volumes | default([]) | list | length > 0 %}volumes:
{% for item in params.volumes | list -%}
- path: "{{ params.data_dir + '/' + item.rel_path }}"
  {% if (item.mode | default('')) != '' 
  %}mode: "{{ item.mode }}"
  {% endif %}
{% endfor %}
{% endif %}

templates:

- dir_base: "main/log/efk"
  src: "docker-compose.yml"
  dest: "docker-compose.yml"
  root: true
  params:
    networks: {{ params.compose.networks | to_json }}
    mainlog:
      driver: "{{ params.compose.mainlog.driver }}"
      options: {{ params.compose.mainlog.options | to_json }}
    fluentd:
      volumes: {{ params.compose.fluentd.volumes | to_json }}
      environments: {{ params.compose.fluentd.environments | to_json }}
      networks: {{ params.compose.fluentd.networks | to_json }}
      ports: {{ params.compose.fluentd.ports | to_json }}
      ulimits: {{ params.compose.fluentd.ulimits | to_json }}
      mem_limit: "{{ params.compose.fluentd.mem_limit }}"
    elasticsearch:
      volumes: {{ params.compose.elasticsearch.volumes | to_json }}
      environments: {{ params.compose.elasticsearch.environments | to_json }}
      networks: {{ params.compose.elasticsearch.networks | to_json }}
      ports: {{ params.compose.elasticsearch.ports | to_json }}
      ulimits: {{ params.compose.elasticsearch.ulimits | to_json }}
      mem_limit: "{{ params.compose.elasticsearch.mem_limit }}"
    kibana:
      volumes: {{ params.compose.kibana.volumes | to_json }}
      environments: {{ params.compose.kibana.environments | to_json }}
      networks: {{ params.compose.kibana.networks | to_json }}
      ports: {{ params.compose.kibana.ports | to_json }}
      ulimits: {{ params.compose.kibana.ulimits | to_json }}
      mem_limit: "{{ params.compose.kibana.mem_limit }}"

- dir_base: "main/log/efk"
  src: ".env"
  dest: ".env"
  root: true
  params: 
    ctx_name: "{{ params.env.ctx_name }}"
    pod_repo: "{{ params.env.pod_repo }}"
    pod_repo_version: "{{ params.env.pod_repo_version }}"
    git_commit: "{{ params.env.git_commit }}"
    pod_env_dir: "{{ params.env.pod_env_dir }}"
    data_dir: "{{ params.env.data_dir }}"
    fluentd_image: "{{ params.env.fluentd_image }}"
    fluentd_version: "{{ params.env.fluentd_version }}"
    elasticsearch_image: "{{ params.env.elasticsearch_image }}"
    elasticsearch_version: "{{ params.env.elasticsearch_version }}"
    kibana_image: "{{ params.env.kibana_image }}"
    kibana_version: "{{ params.env.kibana_version }}"
