{% if params.volumes | default([]) | list | length > 0 %}volumes:
{% for item in params.volumes | list -%}
- path: "{{ params.data_dir + '/' + item.rel_path }}"
  {% if (item.mode | default('')) != '' 
  %}mode: "{{ item.mode }}"
  {% endif %}
{% endfor %}
{% endif %}

env_files: {{ params.env_files | default([]) | to_json }}

{% if (params.compose | default(false) | bool) and 
  (params.services | default([]) | length > 0) 
%}files:

{% if params.compose | default(false) | bool %}

{% for item in ['fluentd', 'elasticsearch', 'kibana'] | list %}

{% if item in (params.services | default([]))
%}- dir_base: "containers/{{ item }}/files"
  src: "Dockerfile"
  dest: "{{ item }}/Dockerfile"
{% endif %}
{% endfor %}
{% endif %}
{% endif %}

{% if 'fluentd' in (params.services | default([]))
%}templates:
  
{% if 'fluentd' in (params.services | default([]))
%}- dir_base: "containers/fluentd/templates"
  src: "elasticsearch.conf"
  dest: "fluentd/fluent.conf"
  params:
    elasticsearch_port: "{{ params.fluentd.elasticsearch_port }}"
    flush_interval: "{{ params.fluentd.flush_interval }}"
{% endif %}
{% endif %}
    