{% set var_params = params.env_params | default({}) %}
{% set var_dest_dir_base = var_params.dirs.dest_dir_base %}
{% set var_volumes_dict = params.volumes_dict | default({}) %}
{% set var_services_data_dict = params.services_data_dict | default({}) %}

{% set var_main_params = var_params.main | default({}) %}
{% set var_pod_params = var_params.pod | default({}) %}

{% set var_volumes = var_main_params.volumes | default([]) %}
{% set var_services = var_main_params.services %}
{% set var_run_services = var_main_params.run_services | default([]) %}

{% set var_env_volumes_dict = var_main_params.volumes_dict | default({}) %}
{% set var_map_ignore_container_dict = var_main_params.map_ignore_container_dict | default({}) %}
{% set var_map_src_path_dict = var_main_params.map_src_path_dict | default({}) %}

{% set var_env_services_data_dict = var_main_params.services_data_dict | default({}) %}
{% set var_base_dir = var_main_params.containers_base_dir | default('containers') %}

{% set var_compose = var_main_params.orchestration in ['docker_compose', 'none'] %}
{% set var_data_dir = var_pod_params.local_data_dir_inside | default(var_pod_params.data_dir, true) %}

{% set var_run = params.run | default({}) %}
{% set var_run_dict = params.run_dict | default({}) %}
{% set var_run_custom = params.run_custom | default({}) %}

{% set ns_run = namespace(vars={}) %}

{% if (var_run | dict2items | list | length) > 0 %}
  {% for var_run_item in var_run | dict2items | list %}
    {% set var_run_item_obj = var_run_dict[var_run_item.value] %}

    {% if (var_run_item_obj | dict2items | list | length) > 0 %}
      {% for var_run_item_inner in var_run_item_obj | dict2items | list %}
        {% set var_key = 'var_' + var_run_item.key + '_' + var_run_item_inner.key %}
        {% set var_value = var_run_item_inner.value %}
        {% set ns_run.vars = ns_run.vars | combine({ var_key: var_value }) %}
      {% endfor %}
    {% endif %}
  {% endfor %}
{% endif %}

{% set ns_run.vars = ns_run.vars | combine(var_run_custom) %}

{% macro define_files(services, run_type) %}

{% for name in services | list %}
{% if not (var_map_ignore_container_dict[name] | default(false) | bool) %}

{% set item_src = var_map_src_path_dict[name] | default(name) %}
{% set item_full_src = var_base_dir + '/' + item_src %}
{% set item_dest = (run_type | bool | ternary('run', 'main')) + '/' + name %}
{% set item_params = var_env_services_data_dict[name] 
| default(var_services_data_dict[name]) | default({}) 
%}

### file start - {{ item_dest }} ({{ item_full_src }})

- src: "{{ item_full_src }}/files/Dockerfile"
  dest: "{{ item_dest }}/Dockerfile"

{% if item_src == 'toolbox'
%}- src: "{{ item_full_src }}/files/aws/config.cfg"
  dest: "{{ item_dest }}/aws/config"
{% endif %}

### file end - {{ item_dest }} ({{ item_full_src }})
{% endif %}
{% endfor %}

{% endmacro %}

{% macro define_templates(services, run_type) %}

{% for name in services | list %}
{% if not (var_map_ignore_container_dict[name] | default(false) | bool) %}

{% set item_src = var_map_src_path_dict[name] | default(name) %}
{% set item_full_src = var_base_dir + '/' + item_src %}
{% set item_dest = (run_type | bool | ternary('run', 'main')) + '/' + name %}
{% set item_params = var_env_services_data_dict[name] 
| default(var_services_data_dict[name]) | default({}) 
%}

### template start - {{ item_dest }} ({{ item_full_src }})

{% if item_src == 'fluentd'
%}- src: "{{ item_full_src }}/templates/elasticsearch.conf"
  dest: "{{ item_dest }}/fluent.conf"
  params:
    elasticsearch_port: "{{ item_params.elasticsearch_port }}"
    flush_interval: "{{ item_params.flush_interval }}"
{% endif %}

{% if item_src == 'mysql'
%}- src: "{{ item_full_src }}/templates/mysqld.cnf"
  dest: "{{ item_dest }}/mysqld.cnf"
  mode: "0644"
  params:
    bind_address: "0.0.0.0"
    default_authentication_plugin: "mysql_native_password"
    collation_server: "utf8mb4_unicode_ci"
    character_set_server: "utf8mb4"
    slow_query_log: "1"
    slow_query_log_file: "/var/log/mysql/mysql-slow.log"
    long_query_time: "3"
    log_error: "/var/log/mysql/error.log"
{% endif %}

{% if item_src == 'nginx'
%}- src: "{{ item_full_src }}/templates/nginx.conf"
  dest: "{{ item_dest }}/nginx.conf"
  params: {{ item_params | to_json }}
{% endif %}

{% if item_src == 'phpmyadmin'
%}- src: "{{ item_full_src }}/templates/config.user.inc.php"
  dest: "{{ item_dest }}/config.user.inc.php"
  params:
    login_cookie_validity: 36000
{% endif %}

{% if item_src == 'test'
%}- src: "{{ item_full_src }}/templates/test.yml"
  dest: "{{ item_dest }}/test.dest.yml"
  mode: "0644"
  params: {{ item_params | to_json }}
{% endif %}

{% if item_src == 'toolbox' %}

{% if (item_params.s3_cli | default('')) == 's3cmd' 
%}- src: "{{ item_full_src }}/templates/s3cmd.cfg"
  dest: "{{ item_dest }}/s3cmd.cfg"
  params:
    access_key: "{{ item_params.bucket.access_key }}"
    secret_key: "{{ item_params.bucket.secret_key }}"
    host_base: "{{ item_params.s3_endpoint }}"
{% endif %}


{% if (item_params.s3_cli | default('')) == 'awscli' 
%}- src: "{{ item_full_src }}/templates/aws/credentials.cfg"
  dest: "{{ item_dest }}/aws/credentials"
  params:
    access_key: "{{ item_params.bucket.access_key }}"
    secret_key: "{{ item_params.bucket.secret_key }}"
{% endif %}
{% endif %}

{% if item_src == 'wordpress' 
%}- src: "{{ item_full_src }}/templates/.env"
  dest: "{{ item_dest }}/.env"
  params: 
    env: "{{ item_params.env }}"
    db_host: "mysql"
    db_port: 3306
    db_name: "wordpress"
    db_user: "wp_user"
    db_password: "{{ item_params.db_password }}"
    db_charset: "utf8mb4"
    db_collate: ""
    home: "{{ item_params.external_host }}"
    siteurl: "{{ item_params.external_host }}"
    auth_key: "{{ item_params.config.auth_key }}"
    secure_auth_key: "{{ item_params.config.secure_auth_key }}"
    logged_in_key: "{{ item_params.config.logged_in_key }}"
    nonce_key: "{{ item_params.config.nonce_key }}"
    auth_salt: "{{ item_params.config.auth_salt }}"
    secure_auth_salt: "{{ item_params.config.secure_auth_salt }}"
    logged_in_salt: "{{ item_params.config.logged_in_salt }}"
    nonce_salt: "{{ item_params.config.nonce_salt }}"
    table_prefix: "wp_"
    wplang: "en_US"
    wp_debug: "{{ item_params.debug | default(false) | lower }}"
{% endif %}

### template end - {{ item_dest }} ({{ item_full_src }})
{% endif %}
{% endfor %}

{% endmacro %}

volumes:

- when: false

{% for name in var_volumes | list %}
{% set item = var_env_volumes_dict[name] | default(var_volumes_dict[name]) %}

### volume start - {{ name }} ({{ item.rel_path }})

- path: "{{ var_data_dir + '/' + item.rel_path }}"

  {% if (item.mode | default('')) != ''%}mode: "{{ item.mode }}"{% endif %}

  {% if (item.when | default('')) != '' %}when: "{{ item.when }}"{% endif %}
  
### volume end - {{ name }} ({{ item.rel_path }})
{% endfor %}

templates:

- when: false

{{ define_templates(var_services, false) }}

{{ define_templates(var_run_services, true) }}

{% if (ns_run.vars | dict2items | list | length) > 0 %}

- src: "main/vars/vars.tpl.sh"
  dest: "vars.sh"
  mode: '0755'
  params: {{ ns_run.vars | to_json }}

{% endif %}
  
files:

- when: false

{{ define_files(var_services, false) }}

{{ define_files(var_run_services, true) }}

{% if (params.run | default({}) | dict2items | list | length) > 0 %}

- src: "{{ var_dest_dir_base }}/vars.sh"
  root: true  
  dest: "vars.sh"
  mode: '0755'

{% endif %}
