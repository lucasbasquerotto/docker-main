templates:

{% set var_local = params.main.local | default(false) | bool %}
{% set var_web = (params.main.type in ['app', 'web']) | bool %}
{% set var_db = (params.main.type in ['app', 'db']) | bool %}

- src: "main/vars/vars.tpl.sh"
  root: true  
  dest: "vars.sh"
  mode: '0755'
  params: 
    scripts_dir: "main/wordpress/scripts"
    script_run_file: "compose.sh"
    script_env_file: >-
      {{ var_local | ternary('compose.env.local.sh', 'compose.env.remote.sh') }}
    script_upgrade_file: >-
      {{ var_web | ternary('compose.upgrade.app.sh', '') }}
    wordpress_dev_repo_dir: >-
      {{ var_local | ternary(params.pod.app.wp_local.dir_rel | default(''), '') }}
    repo_name: "{{ params.pod.repo_name }}"
    pod_env_dir: "{{ params.pod.pod_env_dir }}"
    setup_url: >-
      {{ var_web | ternary(params.main.setup.url | default(''), '') }}
    setup_title: >-
      {{ var_web | ternary(params.main.setup.title | default(''), '') }}
    setup_admin_user: >-
      {{ var_web | ternary(params.credentials.wordpress.setup.admin_user | default(''), '') }}
    setup_admin_password: >-
      {{ var_web | ternary(params.credentials.wordpress.setup.admin_password, '') }}
    setup_admin_email: >-
      {{ var_web | ternary(params.credentials.wordpress.setup.admin_email, '') }}
    setup_local_db_file: >-
      {{ var_db | ternary(params.main.run.local_db_file | default(''), '') }}
    setup_local_uploads_zip_file: >-
      {{ var_web | ternary(params.main.run.local_uploads_zip_file | default(''), '') }}
    setup_remote_db_file: >-
      {{ var_db | ternary(params.main.run.remote_db_file | default(''), '') }}
    setup_remote_uploads_zip_file: >-
      {{ var_web | ternary(params.main.run.remote_uploads_zip_file | default(''), '') }}
    setup_remote_bucket_path_db_dir: >-
      {{ var_db | ternary(params.main.run.remote_bucket_path_db_dir | default(''), '') }}
    setup_remote_bucket_path_uploads_dir: >-
      {{ var_web | ternary(params.main.run.remote_bucket_path_uploads_dir | default(''), '') }}
    setup_remote_bucket_path_db_file: >-
      {{ var_db | ternary(params.main.run.remote_bucket_path_db_file | default(''), '') }}
    setup_remote_bucket_path_uploads_file: >-
      {{ var_web | ternary(params.main.run.remote_bucket_path_uploads_file | default(''), '') }}
    setup_local_seed_data: >-
      {{ var_web | ternary(params.main.run.local_seed_data | default(''), '') }}
    setup_remote_seed_data: >-
      {{ var_web | ternary(params.main.run.remote_seed_data | default(''), '') }}
    s3_endpoint: "{{ params.main.toolbox.s3_endpoint | default('') }}"
    use_aws_s3: "{{ params.main.toolbox.use_aws_s3_cli | default(false) | lower }}"
    use_s3cmd: "{{ params.main.toolbox.use_s3cmd | default(false) | lower }}"
    backup_bucket_name: "{{ params.main.run.backup_bucket_name | default('') }}"
    backup_bucket_path: "{{ params.main.run.backup_bucket_path | default('') }}"
    backup_bucket_db_sync_dir: >-
      {{ var_db | ternary(params.main.run.backup_bucket_db_sync_dir | default(''), '') }}
    backup_bucket_uploads_sync_dir: >-
      {{ var_web | ternary(params.main.run.backup_bucket_uploads_sync_dir | default(''), '') }}
    backup_delete_old_days: "{{ params.main.run.backup_delete_old_days | default(30) }}"
    old_domain_host: "{{ params.main.run.old_domain_host | default('') }}"
    new_domain_host: "{{ params.main.run.new_domain_host | default('') }}"   
    db_user: "{{ params.credentials.wordpress.db.user }}"
    db_pass: "{{ params.credentials.wordpress.db.password }}"
    db_name: "{{ params.credentials.wordpress.db.name }}"

children:

- name: "main/vars/vars.main.yml"
  params:
    local: "{{ params.main.local }}"
    compose: "{{ params.main.compose is defined }}"
    base_dir: "{{ params.main.services_base_dir | default('containers') }}"
    data_dir: "{{ params.pod.local_data_dir_inside | default(params.pod.data_dir, true) }}"
    volumes: {{ params.main.volumes | default([]) | to_json }}
    services: {{ params.main.services | default([]) | to_json }}
    services_dict: 
      nginx:
        includes:
        - "log"
        - "limit_req_zone"
        - "limit_conn_zone"
        - "limit_conn_zone_file_upload"
        - "proxy_cache"
        - "timeouts"
        worker_processes: 1
        worker_connections: 512
        servers:
        - name: "www"
          host: "www.{{ params.main.wordpress.domain }}"
          port: "{{ params.main.wordpress.ssl | bool | ternary('443', '80') }}"
          ssl: "{{ params.main.wordpress.ssl }}"
          redirect:
            protocol: "{{ params.main.wordpress.ssl | bool | ternary('https', 'http') }}"
            host: "{{ params.main.wordpress.domain }}"
            port: "{{ params.main.wordpress.ssl | bool | ternary('443', '80') }}"
        - name: "wordpress"
          host: "{{ params.main.wordpress.domain }}"
          port: "{{ params.main.wordpress.ssl | bool | ternary('443', '80') }}"
          ssl: "{{ params.main.wordpress.ssl }}"
          upstream:
            protocol: "http"
            port: "80"
          locations:
          - path: "/wp-admin/"
            includes:
            - "file_upload"
            - "file_upload_ratelimit"
          - path: "/"
        - name: "phpmyadmin"
          host: "{{ params.main.phpmyadmin.domain }}"
          port: "{{ params.main.phpmyadmin.port }}"
          ssl: "{{ params.main.phpmyadmin.ssl }}"
          upstream:
            protocol: "http"
            port: "80"
          locations:
          - path: "/"
        includes_dict:
          file_upload:
            type: "file_upload"
            params: 
              proxy_read_timeout: "240"
              client_max_body_size: "10M"
          limit_conn_zone:
            type: "limit_conn_zone"
            params: 
              zone: "connlimit"
              size: "10m"
          limit_conn_zone_file_upload:
            type: "limit_conn_zone"
            params: 
              zone: "uploadconnlimit"
              size: "10m"
          limit_req_zone:
            type: "limit_req_zone"
            params: 
              zone: "mainlimit"
              size: "10m"
              rate: "2r/s"
          log:
            type: "log"
            params:
              format: >-
                $remote_addr $sent_http_x_user_id $upstream_response_time $status
                $remote_user [$time_local] "$host" "$request"
                $body_bytes_sent "$http_referer" "$http_user_agent" $request_time
          proxy_cache:
            type: "proxy_cache"
            params: 
              proxy_cache_path: "/var/cache/nginx"
              levels: "1:2"
              keys_zone: "web_cache"
              size: "20m"
              max_size: "200m"
              inactive: "30m"
          file_upload_ratelimit:
            type: "ratelimit"
            params:
              limit_req:
                zone: "mainlimit"
                burst: 6
                nodelay: true
              limit_conn:
                name: "uploadconnlimit"
                value: 5 
          timeouts:
            type: "timeouts"
            params:
              proxy_connect_timeout: "30"
              proxy_send_timeout: "60"
              proxy_read_timeout: "60"
              send_timeout: "60"
              client_body_timeout: "5s"
              client_header_timeout: "5s"
      wordpress:
        env: "{{ params.main.wordpress.env }}"
        domain: "{{ params.main.wordpress.domain }}"
        ssl: "{{ params.main.wordpress.ssl }}"
        db_password: "{{ params.credentials.wordpress.db.password }}"
        config:
          auth_key: "{{ params.credentials.wordpress.config.auth_key }}"
          secure_auth_key: "{{ params.credentials.wordpress.config.secure_auth_key }}"
          logged_in_key: "{{ params.credentials.wordpress.config.logged_in_key }}"
          nonce_key: "{{ params.credentials.wordpress.config.nonce_key }}"
          auth_salt: "{{ params.credentials.wordpress.config.auth_salt }}"
          secure_auth_salt: "{{ params.credentials.wordpress.config.secure_auth_salt }}"
          logged_in_salt: "{{ params.credentials.wordpress.config.logged_in_salt }}"
          nonce_salt: "{{ params.credentials.wordpress.config.nonce_salt }}"
      phpmyadmin:
        domain: "{{ params.main.phpmyadmin.domain }}"
        port: "{{ params.main.phpmyadmin.port }}"
        ssl: "{{ params.main.phpmyadmin.ssl }}"
      mysql: 
        root_password: "{{ params.credentials.mysql.root_password }}"
      toolbox:
        s3_endpoint: "{{ params.main.toolbox.s3_endpoint | default('') }}"
        bucket:
          access_key: "{{ params.credentials.bucket.access_key | default('') }}"
          secret_key: "{{ params.credentials.bucket.secret_key | default('') }}"

- name: "main/compose/vars.compose.yml"
  params: 
    compose: {{ params.main.compose | to_json }}
    env:  
      base_params: {{ params.pod | to_json }}
      env_list: 
      - "DB_HOST={{ params.main.mysql.host }}"
      - "DB_PORT={{ params.main.mysql.port }}"
      - "DB_NAME={{ params.credentials.wordpress.db.name }}"
      - "DB_USER={{ params.credentials.wordpress.db.user }}"
      - "DB_PASSWORD={{ params.credentials.wordpress.db.password }}"
      - "MYSQL_ROOT_PASSWORD={{ params.credentials.mysql.root_password }}"
      - >-
        {{ 
        params.main.local | default(false) | bool 
        | ternary('WP_APP_REPO_DIR=../../apps/' + 
        params.pod.app.wp_local.dir_rel | default(''), '') 
        }}
      env_encoded_list: {{ params.main.env_encoded_list | default([]) | to_json }}