## general vars - start ###

{% set var_local = params.main.local | default(false) | bool %}
{% set var_services = params.main.services %}
{% set var_run = params.main.run | default({}) %}

{% set var_containers_dict = params.main.containers_dict | default({}) %}
{% set var_compose_orchestration = params.pod.pod.orchestration in ['compose', 'none'] %}

## general vars - end ###

{% set var_web = 'wordpress' in var_services %}
{% set var_db = 'mysql' in var_services %}

templates:

{% if var_web %}
  {% set setup_uploads_name = var_run.setup.restore_uploads | default('') %}
  {% set setup_uploads = var_run.setup_uploads_dict[setup_uploads_name] 
    | default({}) %}
  {% set setup_uploads_type = setup_uploads.type | default('') %}

  {% if setup_uploads_name != '' %}
    {% if setup_uploads_type == 'local_file' %}
      {% set setup_local_uploads_file = setup_uploads.src %}
    {% elif setup_uploads_type == 'web_file' %}
      {% set setup_remote_uploads_file = setup_uploads.src %}
    {% elif setup_uploads_type == 'bucket_file' %}
      {% set setup_remote_bucket_path_uploads_file = setup_uploads.src %}
    {% elif setup_uploads_type == 'bucket_dir' %}
      {% set setup_remote_bucket_path_uploads_dir = setup_uploads.src %}
    {% elif setup_uploads_type == '' %}
      {% set error = {} %}
      {{ error['error.setup_uploads_type.not_defined'] }}
    {% else %}
      {% set error = {} %}
      {{ error['error.setup_uploads_type.invalid.' + setup_uploads_type] }}
    {% endif %}
  {% endif %}
{% endif %}

{% set setup_local_uploads_file = setup_local_uploads_file | default('') %}
{% set setup_remote_uploads_file = setup_remote_uploads_file | default('') %}
{% set setup_remote_bucket_path_uploads_file = setup_remote_bucket_path_uploads_file | default('') %}
{% set setup_remote_bucket_path_uploads_dir = setup_remote_bucket_path_uploads_dir | default('') %}

{% if var_db %}
  {% set setup_db_name = var_run.setup.restore_db | default('') %}
  {% set setup_db = var_run.setup_db_dict[setup_db_name] | default({}) %}
  {% set setup_db_type = setup_db.type | default('') %}

  {% if setup_db_name != '' %}
    {% if setup_db_type == 'local_file' %}
      {% set setup_local_db_file = setup_db.src %}
    {% elif setup_db_type == 'web_file' %}
      {% set setup_remote_db_file = setup_db.src %}
    {% elif setup_db_type == 'bucket_file' %}
      {% set setup_remote_bucket_path_db_file = setup_db.src %}
    {% elif setup_db_type == 'bucket_dir' %}
      {% set setup_remote_bucket_path_db_dir = setup_db.src %}
    {% elif setup_db_type == '' %}
      {% set error = {} %}
      {{ error['error.setup_db_type.not_defined'] }}
    {% else %}
      {% set error = {} %}
      {{ error['error.setup_db_type.invalid.' + setup_db_type] }}
    {% endif %}
  {% endif %}
{% endif %}

{% set setup_local_db_file = setup_local_db_file | default('') %}
{% set setup_remote_db_file = setup_remote_db_file | default('') %}
{% set setup_remote_bucket_path_db_file = setup_remote_bucket_path_db_file | default('') %}
{% set setup_remote_bucket_path_db_dir = setup_remote_bucket_path_db_dir | default('') %}

{% set var_wp_domain = var_containers_dict.wordpress.domain %}
{% set var_wp_ssl = var_containers_dict.wordpress.ssl | default(false) %}
{% set var_wp_port = var_containers_dict.wordpress.port 
  | default(var_wp_ssl | bool | ternary('443', '80')) 
%}
{% set var_wp_external_ssl = var_containers_dict.nginx.wordpress.ssl | default(var_wp_ssl) %}
{% set var_wp_external_port = var_containers_dict.nginx.wordpress.port | default(var_wp_port) %}
{% set var_wp_external_host = (var_wp_external_ssl | bool | ternary('https', 'http')) 
  + var_wp_domain 
  + ((var_wp_external_port in ['80', '443']) | ternary('', ':' + var_wp_external_port)) 
%}

- src: "main/vars/vars.tpl.sh"
  root: true  
  dest: "vars.sh"
  mode: '0755'
  params: 
    scripts_dir: "main/wordpress/scripts"
    script_run_file: "compose.sh"
    script_env_file: >-
      {{ var_local | ternary('compose.env.local.sh', 'compose.env.remote.sh') }}
    script_upgrade_file: >-
      {{ var_web | ternary('compose.upgrade.app.sh', '') }}
    wordpress_dev_repo_dir: >-
      {{ var_local | ternary(params.pod.app.wp_local.dir_rel, '') }}
    env_local_repo: "{{ params.pod.env_local_repo }}"
    pod_env_dir: "{{ params.pod.pod_env_dir }}"
    setup_url: >-
      {{ var_web | ternary(var_run.setup.url + ((var_wp_port in ['80', '443']) | ternary('', ':' + var_wp_port)), '') }}
    setup_title: >-
      {{ var_web | ternary(var_run.setup.title, '') }}
    setup_admin_user: >-
      {{ var_web | ternary(params.credentials.wordpress.setup.admin_user, '') }}
    setup_admin_password: >-
      {{ var_web | ternary(params.credentials.wordpress.setup.admin_password, '') }}
    setup_admin_email: >-
      {{ var_web | ternary(params.credentials.wordpress.setup.admin_email, '') }}
    setup_local_db_file: "{{ setup_local_db_file }}"
    setup_local_uploads_zip_file: "{{ setup_local_uploads_file }}"
    setup_remote_db_file: "{{ setup_remote_db_file }}"
    setup_remote_uploads_zip_file: "{{ setup_remote_uploads_file }}"
    setup_remote_bucket_path_db_dir: "{{ setup_remote_bucket_path_db_dir }}"
    setup_remote_bucket_path_uploads_dir: "{{ setup_remote_bucket_path_uploads_dir }}"
    setup_remote_bucket_path_db_file: "{{ setup_remote_bucket_path_db_file }}"
    setup_remote_bucket_path_uploads_file: "{{ setup_remote_bucket_path_uploads_file }}"
    setup_local_seed_data: >-
      {{ 
      (var_web and (var_run.setup.restore_seed | default(false) | bool)) 
      | ternary(var_run.setup.local_seed_data | default(''), '') 
      }}
    setup_remote_seed_data: >-
      {{ 
      (var_web and (var_run.setup.restore_seed | default(false) | bool)) 
      | ternary(var_run.setup.remote_seed_data | default(''), '') 
      }}
    s3_endpoint: "{{ var_containers_dict.toolbox.s3_endpoint | default('') }}"
    use_aws_s3: "{{ var_containers_dict.toolbox.use_aws_s3_cli | default(false) | lower }}"
    use_s3cmd: "{{ var_containers_dict.toolbox.use_s3cmd | default(false) | lower }}"
    backup_bucket_name: "{{ var_run.backup.bucket_name | default('') }}"
    backup_bucket_path: "{{ var_run.backup.bucket_path | default('') }}"
    backup_bucket_db_sync_dir: >-
      {{ var_db | ternary(var_run.backup.bucket_db_sync_dir, '') }}
    backup_bucket_uploads_sync_dir: >-
      {{ var_web | ternary(var_run.backup.bucket_uploads_sync_dir, '') }}
    backup_delete_old_days: "{{ var_run.backup.delete_old_days | default(30) }}"
    old_domain_host: "{{ var_run.setup.old_domain_host | default('') }}"
    new_domain_host: "{{ var_run.setup.new_domain_host | default('') }}"   
    db_user: "{{ params.credentials.wordpress.db.user }}"
    db_pass: "{{ params.credentials.wordpress.db.password }}"
    db_name: "{{ params.credentials.wordpress.db.name }}"

children:

{% if var_compose_orchestration %}

- name: "main/compose/vars.compose.yml"
  params: 
    env_params: {{ params | to_json }}
    env_params_list: 
      - "DB_HOST={{ var_containers_dict.mysql.host }}"
      - "DB_PORT={{ var_containers_dict.mysql.port }}"
      - "DB_NAME={{ params.credentials.wordpress.db.name }}"
      - "DB_USER={{ params.credentials.wordpress.db.user }}"
      - "DB_PASSWORD={{ params.credentials.wordpress.db.password }}"
      - "MYSQL_ROOT_PASSWORD={{ params.credentials.mysql.root_password }}"
      - >-
        {{ 
        var_local | default(false) | bool 
        | ternary('WP_APP_REPO_DIR=../../apps/', '') 
        }}{{ 
        var_local | default(false) | bool 
        | ternary(params.pod.app.wp_local.dir_rel, '') 
        }}

{% else %}
  {% set error = {} %}
  {{ error['error.orchestration.invalid.' + params.pod.pod.orchestration] }}
{% endif %}

- name: "main/vars/vars.main.yml"
  params:
    env_params: {{ params | to_json }}
    volumes_dict: 
      mysql:
        rel_path: "mysql"
        mode: "0755"
      wordpress:
        rel_path: "wordpress/uploads"
        mode: "0777"
    services_data_dict: 
      toolbox:
        s3_endpoint: "{{ var_containers_dict.toolbox.s3_endpoint | default('') }}"
        bucket:
          access_key: "{{ params.credentials.bucket.access_key | default('') }}"
          secret_key: "{{ params.credentials.bucket.secret_key | default('') }}"

      {% if 'nginx' in var_services %}

      nginx:
        vars_dict:
          domains_dict: {{ var_containers_dict | to_json }}
          servers_dict: {{ var_containers_dict.nginx | to_json }}
          upstreams_dict: {{ var_containers_dict | to_json }}
        includes:
        - "log"
        - "limit_req_zone"
        - "limit_conn_zone"
        - "limit_conn_zone_file_upload"
        - "proxy_cache"
        - "timeouts"
        worker_processes: 1
        worker_connections: 512
        servers:
        - "www"
        - "wp"
        - "pma"
        servers_dict:
          www:
            subdomain: "www"
            service: "wordpress"
            redirect:
              protocol: "wp"
          wp:
            subdomain: ""
            service: "wordpress"
            upstream: true
            locations:
            - path: "/wp-admin/"
              includes:
              - "file_upload"
              - "file_upload_ratelimit"
            - path: "/"
          pma:
            subdomain: ""
            service: "phpmyadmin"
            upstream: true
            locations:
            - path: "/"
        includes_dict:
          file_upload:
            type: "file_upload"
            params: 
              proxy_read_timeout: "240"
              client_max_body_size: "10M"
          limit_conn_zone:
            type: "limit_conn_zone"
            params: 
              zone: "connlimit"
              size: "10m"
          limit_conn_zone_file_upload:
            type: "limit_conn_zone"
            params: 
              zone: "uploadconnlimit"
              size: "10m"
          limit_req_zone:
            type: "limit_req_zone"
            params: 
              zone: "mainlimit"
              size: "10m"
              rate: "3r/s"
          log:
            type: "log"
            params:
              format: >-
                $remote_addr $sent_http_x_user_id $upstream_response_time $status
                $remote_user [$time_local] "$host" "$request"
                $body_bytes_sent "$http_referer" "$http_user_agent" $request_time
          proxy_cache:
            type: "proxy_cache"
            params: 
              proxy_cache_path: "/var/cache/nginx"
              levels: "1:2"
              keys_zone: "web_cache"
              size: "20m"
              max_size: "200m"
              inactive: "30m"
          file_upload_ratelimit:
            type: "ratelimit"
            params:
              limit_req:
                zone: "mainlimit"
                burst: 6
                nodelay: true
              limit_conn:
                name: "uploadconnlimit"
                value: 5 
          timeouts:
            type: "timeouts"
            params:
              proxy_connect_timeout: "30"
              proxy_send_timeout: "60"
              proxy_read_timeout: "60"
              send_timeout: "60"
              client_body_timeout: "5s"
              client_header_timeout: "5s"

      {% endif %}
      {% if 'wordpress' in var_services %}

      wordpress:
        env: "{{ var_containers_dict.wordpress.env }}"
        domain: "{{ var_wp_domain }}"
        port: "{{ var_wp_port }}"
        external_host: "{{ var_wp_external_host }}"
        ssl: "{{ var_wp_ssl }}"
        db_password: "{{ params.credentials.wordpress.db.password }}"
        apache: "{{ var_containers_dict.wordpress.apache | default(false) }}"
        apache_params: {{ var_containers_dict.wordpress.apache_params | default({}) | to_json }}
        config:
          auth_key: "{{ params.credentials.wordpress.config.auth_key }}"
          secure_auth_key: "{{ params.credentials.wordpress.config.secure_auth_key }}"
          logged_in_key: "{{ params.credentials.wordpress.config.logged_in_key }}"
          nonce_key: "{{ params.credentials.wordpress.config.nonce_key }}"
          auth_salt: "{{ params.credentials.wordpress.config.auth_salt }}"
          secure_auth_salt: "{{ params.credentials.wordpress.config.secure_auth_salt }}"
          logged_in_salt: "{{ params.credentials.wordpress.config.logged_in_salt }}"
          nonce_salt: "{{ params.credentials.wordpress.config.nonce_salt }}"

      {% endif %}
      {% if 'phpmyadmin' in var_services %}

      {% set var_pma_domain = var_containers_dict.phpmyadmin.domain %}
      {% set var_pma_ssl = var_containers_dict.phpmyadmin.ssl | default(false) %}
      {% set var_pma_port = var_containers_dict.phpmyadmin.port 
        | default(var_pma_ssl | bool | ternary('443', '80')) 
      %}

      phpmyadmin:
        domain: "{{ var_pma_domain }}"
        port: "{{ var_pma_port }}"
        ssl: "{{ var_pma_ssl }}"

      {% endif %}
      {% if 'mysql' in var_services %}

      mysql: 
        root_password: "{{ params.credentials.mysql.root_password }}"

      {% endif %}
